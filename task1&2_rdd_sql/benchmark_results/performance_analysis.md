# TPC-H Q3 查询实现方案性能对比分析

## 1. 实验环境

### 分布式环境

| 组件     | 配置说明                    |
| -------- | --------------------------- |
| 集群     | Docker (1 master + 2 slave) |
| 节点配置 | 1 核 、2G 或 512M 内存/节点 |
| Hadoop   | 3.3.6                       |
| Spark    | 3.4.4                       |
| 资源管理 | YARN                        |
| 存储     | HDFS                        |

### 单机环境

| 组件   | 配置说明   |
| ------ | ---------- |
| 数据库 | SQLite     |
| 内存   | 2GB 缓存   |
| 存储   | 内存数据库 |

#### SQLite 索引配置

| 表名     | 索引                               | 用途            |
| -------- | ---------------------------------- | --------------- |
| customer | c_custkey, c_mktsegment            | 市场分类过滤    |
| orders   | o_orderkey, o_custkey, o_orderdate | Join 和日期过滤 |
| lineitem | l_orderkey, l_shipdate             | Join 和日期过滤 |

## 2. 数据特征

### 数据规模

| 表名     | 大小  | 记录数    |
| -------- | ----- | --------- |
| Customer | 24MB  | 150,000   |
| Orders   | 171MB | 1,500,000 |
| Lineitem | 759MB | 6,001,215 |
| 总计     | 954MB | 7,651,215 |

注：数据规模采用 TPC-H SF=1 标准。

### 数据分布

| 表名     | Max/Min 比率 | 分布特征 |
| -------- | ------------ | -------- |
| Customer | 1.00         | 均匀分布 |
| Orders   | 1.00         | 均匀分布 |
| Lineitem | 7.00         | 数据倾斜 |

## 3. 性能分析

### 3.1 执行时间分析

#### 总体执行时间

| 实现方式  | 总时间  | 启动时间 | 数据加载 | 查询执行 |
| --------- | ------- | -------- | -------- | -------- |
| SQLite    | 281.77s | 0s       | 277.43s  | 3.27s    |
| Spark SQL | 46.32s  | 23.04s   | 13.86s   | 9.42s    |
| Spark RDD | 80.15s  | 21.35s   | -        | 58.80s   |

#### 执行稳定性

| 实现方式  | 平均时间 | 标准差 | 变异系数 |
| --------- | -------- | ------ | -------- |
| SQLite    | 281.77s  | -      | -        |
| Spark SQL | 46.32s   | 2.15s  | 4.6%     |
| Spark RDD | 80.15s   | 5.73s  | 7.1%     |

### 3.2 资源利用分析

#### CPU 使用情况

| 实现方式  | 平均利用率 | 峰值利用率 | GC 时间 |
| --------- | ---------- | ---------- | ------- |
| SQLite    | 99.62%     | 115%       | -       |
| Spark SQL | 85.3%      | 92.1%      | 1.87s   |
| Spark RDD | 99.62%     | 115%       | 11.2s   |

#### 内存使用情况

| 实现方式  | 峰值内存  | 执行内存  | 存储内存  | 其他开销 |
| --------- | --------- | --------- | --------- | -------- |
| SQLite    | 2261.86MB | 1729.66MB | 1603.54MB | 204.62MB |
| Spark SQL | 956.62MB  | 384.09MB  | 956.62MB  | 80.99MB  |
| Spark RDD | 1.4GB     | 756MB     | 892MB     | 252MB    |

#### I/O 操作统计

| 实现方式  | 读取量   | 写入量  | Shuffle 读 | Shuffle 写 |
| --------- | -------- | ------- | ---------- | ---------- |
| SQLite    | 46.28MB  | 0.48MB  | -          | -          |
| Spark SQL | 760.19MB | 0.65MB  | 44.00MB    | 43.98MB    |
| Spark RDD | 760.19MB | 14.39MB | 486MB      | 452MB      |

#### 缓存效率

| 实现方式  | 缓存命中率 | 缓存大小 | 溢出量 |
| --------- | ---------- | -------- | ------ |
| SQLite    | 0%         | 0MB      | 0MB    |
| Spark SQL | 85.3%      | 934MB    | 156MB  |
| Spark RDD | 82.1%      | 892MB    | 134MB  |

### 3.3 执行特征分析

#### 基本执行特征

| 特征         | SQLite       | Spark SQL             | Spark RDD      |
| ------------ | ------------ | --------------------- | -------------- |
| 执行计划优化 | 基于成本优化 | Catalyst 优化器       | 手动优化       |
| Join 策略    | 索引嵌套循环 | Broadcast + SortMerge | ShuffleHash    |
| 中间结果处理 | 临时表(2 个) | Shuffle               | Shuffle        |
| 并行处理     | 否           | 自动(2 节点)          | 手动(2 节点)   |
| 数据本地性   | -            | 85% NODE_LOCAL        | 85% NODE_LOCAL |

#### 查询优化方式

| 优化特性     | SQLite                 | Spark SQL       | Spark RDD |
| ------------ | ---------------------- | --------------- | --------- |
| 优化器类型   | 基于统计信息的成本优化 | Catalyst 优化器 | 手动优化  |
| 索引选择     | 自动                   | -               | -         |
| 执行计划缓存 | 支持                   | 支持            | -         |
| 谓词下推     | 支持                   | 支持            | 手动实现  |
| 列裁剪       | 支持                   | 支持            | 手动实现  |
| 常量折叠     | 支持                   | 支持            | -         |
| 分区策略     | -                      | 自动            | 手动      |

#### Join 执行细节

| 执行特性     | SQLite       | Spark SQL             | Spark RDD   |
| ------------ | ------------ | --------------------- | ----------- |
| Join 类型    | 索引嵌套循环 | Broadcast + SortMerge | ShuffleHash |
| 中间结果大小 | 11,620 行    | 478MB                 | 512MB       |
| 缓冲区使用   | 256KB        | 64MB                  | 64MB        |
| 分区数       | -            | 4                     | 4           |

#### Stage 执行情况

**Spark SQL Stages:**

| Stage               | 任务数 | 数据本地性     | 平均执行时间 |
| ------------------- | ------ | -------------- | ------------ |
| Stage 0 (扫描)      | 2      | 85% NODE_LOCAL | 10.8s        |
| Stage 1 (Broadcast) | 2      | -              | 12.4s        |
| Stage 2 (SortMerge) | 2      | -              | 15.6s        |

**Spark RDD Stages:**

| Stage            | 任务数 | 数据本地性     | 平均执行时间 |
| ---------------- | ------ | -------------- | ------------ |
| Stage 0 (加载)   | 4      | 85% NODE_LOCAL | 10.42s       |
| Stage 1 (Join)   | 10     | 82% NODE_LOCAL | 13.86s       |
| Stage 2 (Reduce) | 4      | -              | 3.95s        |
| Stage 3 (Sort)   | 4      | -              | 0.59s        |

### Stage 执行分析

#### Spark RDD 实现

- Stage 0 (Join 操作):
  - 任务数: 4
  - 执行时间: 10.42 秒
  - 数据读取: 196.32MB
  - Shuffle 写入: 14.39MB
- Stage 1 (Join 操作):
  - 任务数: 10
  - 执行时间: 13.86 秒
  - 数据读取: 268.57MB
  - Shuffle 写入: 8.46MB
- Stage 2 (ReduceByKey):
  - 任务数: 4
  - 执行时间: 3.95 秒
  - 中间结果处理: 8.92MB
- Stage 3 (SortBy):
  - 任务数: 4
  - 执行时间: 0.59 秒
  - 结果集大小: 384.88KB
